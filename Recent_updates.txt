# Gap Night - Recent Updates Log
# Last Updated: Feb 3, 2026

## Comprehensive Site Polish - Feb 3, 2026 âœ…

### Bug Fixes
- **Google Sign-In Timeout** - Added 5-second timeout with fallback state instead of infinite loading
- **NotFound Page** - Redesigned with proper Navigation, Footer, GapNight branding

### UI/UX Improvements
- **NotFound (404) Page** - Complete redesign with:
  - GapNight logo centered in large 404 text
  - Proper Navigation and Footer
  - "Go Home" and "Browse Deals" action buttons
  - Consistent styling with rest of site
- **Accessibility** - Added aria-labels to icon buttons
- **OAuth UX** - Shows "Google Sign-In unavailable" after timeout instead of infinite spinner

### Code Quality
- Audited all main pages: Landing, Deals, DealDetail, Booking, Account
- Verified auth pages: Login, Signup, ForgotPassword, ResetPassword, VerifyEmail
- Confirmed Navigation and Footer consistency across all pages

---

## Booking & OAuth Improvements - Feb 3, 2026 âœ…

### Bug Fixes
- Fixed: Bookings made while logged in now correctly appear in Account bookings tab
  - Added `credentials: "include"` to all booking API calls to send session cookies

### New Features
- **Account creation prompt during booking** - Non-logged-in users see a prompt to create an account (still allows guest checkout)
- **Google Sign-In** - Users can now sign in/sign up with their Google account
  - Added Google Identity Services script
  - OAuth buttons on Login and Signup pages
  - Server-side OAuth callback route `/api/auth/oauth/google`
- **Apple Sign-In (Coming Soon)** - UI ready, backend routes prepared
  - Server-side OAuth callback route `/api/auth/oauth/apple`

### Database Changes
- Added `google_id` and `apple_id` columns to users table for OAuth linking

### Environment Variables (new)
- `VITE_GOOGLE_CLIENT_ID` - Google OAuth client ID from Google Cloud Console

---

## Auth UI Redesign - Feb 3, 2026 âœ…

### Improvements Made
- Added "Sign in" button to Navigation (desktop dropdown + mobile menu)
- Redesigned Login page with GapNight logo, rounded cards, stats section
- Redesigned Signup page with password strength indicator, benefits list
- Redesigned ForgotPassword page with success state
- Redesigned ResetPassword page with validation feedback
- Redesigned VerifyEmail page with loading/success/error states
- All auth pages now use consistent GapNight aesthetic:
  - Proper header with logo
  - Footer included
  - Rounded-xl inputs and buttons
  - Primary color accents
  - Shadow effects

---

## User Authentication System - Feb 3, 2026 âœ…

### Features Implemented
- **User signup/login** with secure password hashing (bcrypt, 12 rounds)
- **Email verification** with tokenized links (24hr expiry)
- **Password reset** flow with one-time use tokens (1hr expiry)
- **Remember me** option (30 days vs 24 hours session)
- **Account management** - profile, password change, delete account
- **Booking history** - view all bookings linked to account
- **Deal alerts** - save city/price preferences (UI ready, email sending TBD)

### Security Features
- HttpOnly secure cookies for sessions
- CSRF protection with double-submit cookie pattern
- Rate limiting on auth endpoints
- Security headers (CSP, X-Frame-Options, HSTS, etc.)
- Session revocation on password change
- "Log out of all devices" feature

### Database Tables Added
- `users` - id, email, passwordHash, name, emailVerifiedAt, deletedAt
- `user_sessions` - sessionHash, userId, expiresAt, revokedAt, userAgent, ip
- `email_tokens` - tokenHash, type, userId, expiresAt, usedAt
- `user_alert_preferences` - preferredCity, maxPrice, alertFrequency
- `bookings.user_id` - links bookings to user accounts

### New Files
- `server/user-auth.ts` - Auth logic, session management, CSRF
- `server/user-routes.ts` - Auth API endpoints
- `server/user-email.ts` - Verification and reset emails
- `client/src/hooks/useAuth.ts` - Auth state management (Zustand)
- `client/src/pages/Login.tsx` - Login page
- `client/src/pages/Signup.tsx` - Signup page with password strength
- `client/src/pages/ForgotPassword.tsx` - Password reset request
- `client/src/pages/ResetPassword.tsx` - New password form
- `client/src/pages/VerifyEmail.tsx` - Email verification handler
- `client/src/pages/Account.tsx` - User dashboard (profile, bookings, alerts)
- `SECURITY.md` - Security documentation
- `.env.example` - Environment variable template

### Routes Added
- `/login`, `/signup`, `/forgot-password`, `/reset-password`, `/verify-email`, `/account`

### Booking Integration
- Bookings automatically linked to user account when logged in
- Guest checkout still supported (no account required)
- View booking history in account dashboard

---

## Railway Deployment - Feb 2, 2026

### Deployed to Railway âœ…
- App URL: https://lavish-solace-production-5a00.up.railway.app
- Custom domain: gapnight.com (CNAME â†’ hn5y4yrs.up.railway.app)
- GitHub repo: https://github.com/coopism/Gapppnigh

### Deployment Fixes
- File: `package.json` - Removed `cross-env` from start script (not available in production)
- File: `server/index.ts` - Changed host from `localhost` to `0.0.0.0` for Railway

### Environment Variables (Railway)
- DATABASE_URL - References Railway Postgres
- NODE_ENV=production
- SESSION_SECRET
- STRIPE_PUBLISHABLE_KEY
- STRIPE_SECRET_KEY
- VITE_STRIPE_PUBLISHABLE_KEY

### DNS Setup Required
Add CNAME record at domain registrar:
- Type: CNAME
- Name: @
- Value: hn5y4yrs.up.railway.app

### Database Fix - Feb 2, 2026
- Removed drizzle-kit migrate() - was causing bundled code output crash
- Now using raw SQL `CREATE TABLE IF NOT EXISTS` in bootstrap.ts
- Tables created programmatically on app startup

### Crash Prevention - Feb 2, 2026
- File: `server/index.ts` - Wrapped bootstrapDatabase() in try-catch
- File: `server/bootstrap.ts` - Added try-catch around all DB operations
- App now starts even if database connection fails
- Graceful error logging instead of crashes

### DNS Configured - Feb 2, 2026 âœ…
- CNAME record added at domain registrar
- Type: CNAME | Name: www | Value: hn5y4yrs.up.railway.app
- Root domain forwarding to www.gapnight.com

### Security Audit - Feb 2, 2026 âœ…
- Removed 70+ Replit agent state files from repo
- Updated .gitignore to exclude: .local/, .replit, IDE files, logs
- Verified: No API keys or secrets committed
- Verified: .env file properly gitignored

### Email System - Feb 2, 2026 âœ…
- Updated all contact emails to info@gapnight.com
- Booking confirmation emails sent via Resend API
- Hotel inquiry forms forward to info@gapnight.com
- Waitlist signups forward to info@gapnight.com
- Requires RESEND_API_KEY environment variable in Railway

---

## Date & Guest Filters + Room Capacity - Feb 2, 2026

### Date Filters - FIXED
- File: `client/src/pages/Home.tsx`
- Date picker UI now actually filters deals by check-in date
- Supports: "Within X days", "By Month", and "Specific dates" modes
- Nights filter also works (filters deals by number of nights)
- Passes `startDate`, `endDate`, `nights` params to API

### Guest Filter - FIXED  
- File: `client/src/pages/Home.tsx`
- Guest count now filters deals by room capacity
- Only shows deals that can accommodate selected number of guests
- Passes `minGuests` param to API

### Room Capacity (maxGuests) - NEW
- File: `shared/schema.ts` - Added `maxGuests` field to deals table
- File: `server/routes.ts` - Added filtering by `minGuests` param
- File: `client/src/components/DealCard.tsx` - Shows guest capacity with icon
- File: `client/src/pages/DealDetail.tsx` - Shows "Sleeps X" badge in About section + in availability options
- File: `client/src/hooks/use-deals.ts` - Added filter params to hook
- File: `scripts/seed.ts` - Updated seed data with maxGuests values
- Display: Shows "Room Type â€¢ ðŸ‘¤2" format on deal cards and detail page

### API Changes
- `GET /api/deals` now accepts:
  - `startDate` - Filter deals with check-in >= this date
  - `endDate` - Filter deals with check-in <= this date  
  - `nights` - Filter deals with exact number of nights
  - `minGuests` - Filter deals where maxGuests >= this value

---

## Deal Holds & Booking Availability - Feb 1, 2026 (11:15pm)

### 5-Minute Deal Holds
- When user enters booking page, deal is held for 5 minutes
- Other users cannot book or see held deals
- Hold is released when user leaves page or completes booking
- Prevents double-booking scenarios

### Booked Deals Hidden from Listings
- Confirmed bookings are filtered out of deal listings
- Users won't see deals that have already been booked
- File: `server/storage.ts` - getDeals() filters booked deals
- File: `server/routes.ts` - Also filters held deals

### New API Endpoints
- `POST /api/deals/:dealId/hold` - Create 5-min hold
- `DELETE /api/deals/:dealId/hold` - Release hold
- `GET /api/deals/:dealId/availability` - Check if available

---

## Stripe Payment & UI Fixes - Feb 1, 2026 (10:40pm)

### Payment Flow - FIXED (CRITICAL)
- **Root cause**: Nested forms - StripePaymentForm had `<form>` inside Booking's `<Form>`
- **Fix**: Changed StripePaymentForm from `<form>` to `<div>`, button from `type="submit"` to `type="button"` with `onClick`
- File: `client/src/components/StripePaymentForm.tsx`
- Uses `stripe.confirmCardPayment()` with CardElement (no redirects)
- Auto-submits booking after successful payment
- Payment â†’ Booking confirmation is now seamless

### Rate Limiting Fix for Payment Intent
- File: `server/rate-limit.ts`
- Added separate `paymentRateLimit` (30 requests/hour)
- Prevents blocking during payment testing
- File: `server/routes.ts` - Updated to use new limiter

### Stripe Payment Form Fix
- File: `client/src/components/StripePaymentForm.tsx`
- Fixed multiple API calls on re-renders using useRef
- Payment intent only created once when guest details complete
- Added waiting state before guest details are filled

### Force Light Mode
- File: `client/src/components/ThemeProvider.tsx`
- Forced light mode for better visual appearance
- Disabled theme toggle functionality

---

## Bug Fixes & Improvements - Feb 1, 2026

### BUG-003: Font Inconsistency - FIXED
- File: `client/src/pages/ComingSoon.tsx`
- Changed: Removed inline `style={{ fontFamily: "Georgia, serif" }}` 
- Now uses: `font-display` class for consistent theming
- Also fixed same issue in `client/src/pages/Landing.tsx`

### BUG-007: Image Error Handling - FIXED
- Added `onError` handlers with fallback image to:
  - `client/src/components/DealCard.tsx`
  - `client/src/pages/DealDetail.tsx`
  - `client/src/pages/Landing.tsx`
  - `client/src/pages/Booking.tsx`
- Fallback: Unsplash hotel image placeholder

### BUG-008: Aria Labels on Icon Buttons - FIXED
- File: `client/src/pages/DealDetail.tsx`
- Added `aria-label` to Share and Favorite icon buttons

### Missing Amenity Icons - FIXED
- File: `client/src/pages/DealDetail.tsx`
- Added icons for: Bar, Beach Access, Room Service, Concierge

### Rate Limiting - IMPLEMENTED
- Created: `server/rate-limit.ts` 
- Features:
  - In-memory rate limiting store
  - Configurable attempts and time windows
  - Automatic cleanup of expired entries
- Applied to:
  - `/api/auth/register` - 5 attempts per 15 minutes
  - `/api/auth/login` - 5 attempts per 15 minutes  
  - `/api/bookings` - 10 bookings per hour
- Returns 429 status with Retry-After header when exceeded

### Already Fixed (Verified):
- BUG-001: Currency formatting - formatPrice utility already correct
- BUG-002: Mobile hamburger data-testid - already present
- BUG-005: DealCard amenity icons - already present
- BUG-006: Navigation link consistency - already consistent
- BUG-011: Focus rings on category chips - already present

## Files Modified
1. `client/src/pages/ComingSoon.tsx` - Font fix
2. `client/src/pages/Landing.tsx` - Font fix, image fallback
3. `client/src/pages/DealDetail.tsx` - Amenity icons, aria-labels, image fallback
4. `client/src/components/DealCard.tsx` - Image fallback
5. `client/src/pages/Booking.tsx` - Image fallback
6. `server/routes.ts` - Rate limiting integration
7. `server/rate-limit.ts` - NEW: Rate limiting middleware

## Intended Results
- Improved accessibility with aria-labels
- Graceful image loading failures with fallbacks
- Consistent font theming across pages
- Security improvement with rate limiting on auth/booking endpoints
- All 12 bugs from BUG_REPORT.md addressed

## Additional Fixes (Pre-existing Technical Debt)

### TypeScript Type Errors - FIXED
- File: `server/routes.ts`
- Fixed `sanitizeString` to accept `string | string[]` for Express params/query
- Fixed schema mismatches in waitlist route (removed non-existent `name` field)
- Fixed schema mismatches in hotel inquiry route (use correct field names)

### ThemeProvider Dark Mode - FIXED
- File: `client/src/components/ThemeProvider.tsx`
- Added proper `toggleTheme` and `setTheme` functions
- Added theme persistence to localStorage
- Added system preference detection

## Build Status
- TypeScript check: âœ… PASSED (0 errors)
- All 12 bugs from BUG_REPORT.md: âœ… ADDRESSED

## Additional Changes
- Updated `package.json` scripts to use `cross-env` for Windows compatibility
- Added `cross-env` as devDependency

## Stripe Payment Integration - Feb 1, 2026

### Server-Side (`server/stripe.ts`) - NEW
- Created Stripe configuration module
- Functions: `createPaymentIntent`, `getPaymentIntent`, `confirmPaymentSuccess`, `createRefund`
- Graceful handling when STRIPE_SECRET_KEY not configured

### New API Endpoints
- `GET /api/stripe/config` - Returns Stripe configuration status and publishable key
- `POST /api/stripe/create-payment-intent` - Creates payment intent for booking

### Booking Flow Updated
- File: `server/routes.ts`
  - Added `paymentIntentId` to booking schema
  - Payment verification before booking creation
  - Rate limiting applied to payment intent creation

### Client-Side Payment Form (`client/src/components/StripePaymentForm.tsx`) - NEW
- Full Stripe Elements integration
- Payment Element with tabs layout
- Loading states and error handling
- Secure payment badge and card logos
- Disabled state until guest details are valid

### Booking Page Updated (`client/src/pages/Booking.tsx`)
- Removed manual card input fields
- Integrated StripePaymentForm component
- Two-step flow: Pay first, then confirm booking
- Guest details validation before payment enabled
- Payment success state management

### Environment Variables Required
```
STRIPE_SECRET_KEY=sk_test_xxxxxxxxxxxxx
STRIPE_PUBLISHABLE_KEY=pk_test_xxxxxxxxxxxxx
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_xxxxxxxxxxxxx  # For client-side (Vite)
```

### Stripe Keys Configured âœ…
- Test/Sandbox mode keys added to `.env`
- Ready for testing payments

### Packages Added
- `stripe` - Server-side Stripe SDK
- `@stripe/stripe-js` - Client-side Stripe.js loader
- `@stripe/react-stripe-js` - React components for Stripe Elements

## To Run
Ensure environment variables are set in your .env file:
```
DATABASE_URL=postgresql://user:password@localhost:5432/gapnight
STRIPE_SECRET_KEY=sk_test_xxxxxxxxxxxxx
STRIPE_PUBLISHABLE_KEY=pk_test_xxxxxxxxxxxxx
```
Then run: `npm run dev`
